package com.south.servlet;


import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.south.dao.UserDao;
import com.south.dao.UserDaoImpl;
import com.south.util.CacheManager;
import com.south.util.WeixinUtil;

import net.sf.json.JSONObject;

/**
 * @author yao
 *回调函数，微信公众号授权,获得用户的openId
 */
@WebServlet("/callBack.do")
public class CallBackServlet extends HttpServlet{

	private static final long serialVersionUID = -6135777238592953632L;


	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
	
		
		//通过code换取网页授权access_token
		String code=req.getParameter("code");
		String url="https://api.weixin.qq.com/sns/oauth2/access_token?"
				+ "appid="+WeixinUtil.APPID
				+ "&secret="+WeixinUtil.APPSECRET
				+ "&code="+code
				+ "&grant_type=authorization_code";
		JSONObject jsonObject=WeixinUtil.doGetStr(url);
		/*String refresh_token=jsonObject.getString("refresh_token");
		
		String refresh_url="https://api.weixin.qq.com/sns/oauth2/refresh_token?"
				+ "appid="+WeixinUtil.APPID
				+ "&grant_type=refresh_token"
				+ "&refresh_token="+refresh_token;
		JSONObject jsonObject1=WeixinUtil.doGetStr(refresh_url);*/
		String openid=jsonObject.getString("openid");
		String token=jsonObject.getString("access_token");
		
		//通过网页授权access_token和openid获取用户基本信息
		String infoUrl="https://api.weixin.qq.com/sns/userinfo?"
				+ "access_token="+token
				+ "&openid="+openid
				+ "&lang=zh_CN";
		
		//获取用户的基本信息
		JSONObject userInfo=WeixinUtil.doGetStr(infoUrl);
		//System.out.println(userInfo);
		String nickName=userInfo.getString("nickname");
		int sex=userInfo.getInt("sex");
		/*System.out.println("nickName="+nickName+",sex="+sex);
		System.out.println("---------CallBackServlet----------");*/
		req.setAttribute("nickName", nickName);
		req.setAttribute("sex", sex);
		req.setAttribute("openid", openid);
		req.getRequestDispatcher("/OAuth/register.jsp").forward(req, resp);
		
		
	}

	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		
	}
	
}
